<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mental Health Pathways — Conference SPA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- QR Code generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --brand:#076EBF;          /* azure */
      --accent:#00ADB5;         /* teal */
      --ink:#EAF0F5;            /* text on dark */
      --muted:#A8B3C2;          /* muted text on dark */
      --bg:#0B1220;             /* dark gradient start */
      --bg2:#0F1627;            /* dark gradient end */
      --card-start: rgba(255,255,255,.05);
      --card-end: rgba(255,255,255,.02);
      --border: rgba(255,255,255,.10);
      --ring: rgba(0,0,0,.15);
      --band-shadow: rgba(0,173,181,.25);
      --grid: rgba(255,255,255,.08);
      --grid2: rgba(255,255,255,.06);
      --tick: #DBE7FF;
      --tick-contrast: #ffffff;
      --page-ink: #F8FBFF;
    }
    /* Light theme overrides */
    .light {
      --ink:#111827;
      --muted:#4B5563;
      --bg:#f7fbff;
      --bg2:#ffffff;
      --card-start: rgba(0,0,0,.02);
      --card-end: rgba(0,0,0,.00);
      --border: rgba(0,0,0,.08);
      --ring: rgba(0,0,0,.06);
      --band-shadow: rgba(0,0,0,.08);
      --grid: rgba(0,0,0,.08);
      --grid2: rgba(0,0,0,.06);
      --tick:#1F2937;
      --tick-contrast:#111827;
      --page-ink:#0B1220;
    }

    html, body { height: 100%; background: linear-gradient(160deg, var(--bg), var(--bg2)); color: var(--ink); }
    .navbar { background: rgba(15,22,39,.9); backdrop-filter: blur(6px); border-bottom: 1px solid rgba(255,255,255,.06); }
    .light .navbar { background: rgba(255,255,255,.90); border-bottom: 1px solid rgba(0,0,0,.08); }
    .navbar-brand { color:#fff !important; font-weight:700; letter-spacing:.3px; }
    .light .navbar-brand { color:#111827 !important; }
    .nav-link { color:#d0d8e0 !important; }
    .light .nav-link { color:#374151 !important; }
    .nav-link.active { color:#fff !important; font-weight:600; border-bottom:2px solid var(--accent); }
    .light .nav-link.active { color:#111827 !important; }

    .section {
      min-height: 100vh;
      padding-top: 84px;        /* account for fixed navbar */
      padding-bottom: 28px;
      display:flex;
      align-items:center;
    }
    .deck-card{
      background: linear-gradient(180deg, var(--card-start), var(--card-end));
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 10px 30px var(--ring);
    }
    .band {
      background: linear-gradient(90deg, var(--brand), var(--accent));
      color:#fff; border-radius:14px; padding:22px 22px; margin-bottom:18px;
      box-shadow: 0 8px 24px var(--band-shadow);
    }
    h1, h2, h3 { color: var(--page-ink); }
    .light h1, .light h2, .light h3 { color:#0b1220; }
    h1 { font-weight:800; letter-spacing:.2px; }
    .muted { color: var(--muted) !important; }
    .kicker { text-transform:uppercase; letter-spacing: .22em; font-size:.8rem; color:#9cccf9 }
    .light .kicker { color:#076EBF; }
    .btn-brand { background: var(--accent); border:none; color:#002b2e; font-weight:600; }
    .btn-brand:hover { filter: brightness(.95); }
    .btn-outline-contrast { color:#EAF0F5; border-color:#EAF0F5; }
    .btn-outline-contrast:hover { background:#EAF0F5; color:#0B1220; }
    .light .btn-outline-contrast { color:#111827; border-color:#111827; }
    .light .btn-outline-contrast:hover { background:#111827; color:#ffffff; }

    .grid-2 { display:grid; grid-template-columns: 1fr; gap:18px; }
    @media (min-width: 992px){ .grid-2 { grid-template-columns: 1fr 1fr; } }

    canvas { max-width:100%; height: 420px !important; }
    .mini { font-size:.9rem; }

    .footer {
      position:fixed; left:0; right:0; bottom:0;
      display:flex; justify-content:space-between; align-items:center;
      padding:8px 16px; font-size:.85rem; color:#c7d1dd;
      background:rgba(0,0,0,.2); border-top:1px solid rgba(255,255,255,.06); backdrop-filter: blur(6px);
    }
    .light .footer {
      color:#374151; background:rgba(255,255,255,.85); border-top:1px solid rgba(0,0,0,.08);
    }

    .pill {
      background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12);
      border-radius: 999px; padding:6px 12px; margin:2px 0;
    }
    .light .pill {
      background: rgba(0,0,0,.03); border:1px solid rgba(0,0,0,.08);
    }

    /* QR container ensures contrast in both themes */
    .qr-wrap {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px;
      display:inline-block;
      box-shadow: 0 8px 24px rgba(0,0,0,.15);
    }

    /* Historic practice cards + image styling */
    .hist-card{
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      background: linear-gradient(180deg, var(--card-start), var(--card-end));
      height:100%;
      text-align:center;
    }
    .hist-title{ font-weight:700; margin-top:8px; }
    .hist-img{ width:100%; aspect-ratio: 4/3; object-fit: cover; border-radius:12px; }
    .hist-wide{ width:100%; aspect-ratio: 16/9; object-fit: cover; border-radius:12px; }

    /* Print to PDF */
    @media print{
      .navbar, .footer, .controls { display:none !important; }
      body { background: #fff; color:#111; }
      .section { min-height: auto; page-break-inside: avoid; }
      .deck-card { box-shadow: none; border:1px solid #ddd; }
      h1, h2, h3 { color:#000; }
    }
  </style>
</head>
<body>

  <!-- NAV -->
  <nav class="navbar navbar-expand-lg fixed-top navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#quiz">Mental Health Pathways • Oman</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="nav" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="#quiz">Quick Quiz</a></li>
          <li class="nav-item"><a class="nav-link" href="#mh-definition">What is mental health?</a></li>
          <li class="nav-item"><a class="nav-link" href="#history">Mental illness: History</a></li>
          <li class="nav-item"><a class="nav-link" href="#cover">Cover</a></li>
          <li class="nav-item"><a class="nav-link" href="#background">Background</a></li>
          <li class="nav-item"><a class="nav-link" href="#methods">Methods</a></li>
          <li class="nav-item"><a class="nav-link" href="#patients">Patients</a></li>
          <li class="nav-item"><a class="nav-link" href="#relatives">Relatives</a></li>
          <li class="nav-item"><a class="nav-link" href="#beliefs">Beliefs</a></li>
          <li class="nav-item"><a class="nav-link" href="#dui">DUI</a></li>
          <li class="nav-item"><a class="nav-link" href="#predictors">Predictors</a></li>
          <li class="nav-item"><a class="nav-link" href="#takeaways">Takeaways</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- QUICK QUIZ (FIRST PAGE) -->
  <section id="quiz" class="section">
    <div class="container">
      <div class="deck-card p-4 p-lg-5 text-center">
        <div class="band"><h1 class="m-0">Quick Quiz</h1></div>

        <div class="mb-4">
          <div class="qr-wrap" aria-label="QR code for Quick Quiz link">
            <div id="qrCode" style="width: 256px; height: 256px;"></div>
          </div>
        </div>

        <p class="lead">
          Join the quiz at:<br>
          <a id="quizLink" href="https://www.ahaslides.com/GMHC2025" target="_blank" rel="noopener" class="fw-bold">
            www.ahaslides.com/GMHC2025
          </a>
        </p>

        <div class="mt-3">
          <button id="start" class="btn btn-brand btn-lg me-2">Start Presentation</button>
          <button id="toggleTheme" class="btn btn-outline-contrast btn-lg" aria-pressed="true">Dark Mode</button>
        </div>
        <p class="mini mt-3 muted">Scan the QR code or open the link above on your device.</p>
      </div>
    </div>
  </section>

  <!-- PAGE 1: WHAT IS MENTAL HEALTH? -->
  <section id="mh-definition" class="section">
    <div class="container">
      <div class="deck-card p-4 p-lg-5">
        <div class="band"><h2 class="m-0">What is mental health?</h2></div>
        <ul class="fs-5">
          <li>
            <strong>Health:</strong> a state of complete physical, <em>mental</em>, and social well-being,
            not merely the absence of disease or infirmity.
          </li>
          <li class="mt-3">
            <strong>Mental health:</strong> a state of well-being in which an individual realizes
            his or her own abilities, can cope with the normal stresses of life, can work
            productively and fruitfully, and is able to make a contribution to his or her community (WHO).
          </li>
        </ul>
      </div>
    </div>
  </section>

  <!-- PAGE 2: 'MENTAL ILLNESS': HISTORY -->
  <section id="history" class="section">
    <div class="container">
      <div class="deck-card p-4 p-lg-5">
        <div class="band"><h2 class="m-0">‘Mental illness’: History</h2></div>

        <div class="fs-5">
          <p><strong>Ancient World</strong> – Wrath of the Gods</p>
          <p><strong>Middle Ages</strong> – Evil Spirits, Witches, Humoral Imbalance</p>
          <p><strong>Enlightenment</strong> – Emergence of the Mind</p>
          <p><strong>18th Century</strong> – Organicity and Asylums</p>
          <p><strong>19th Century</strong> – Compassionate care</p>
          <p><strong>Early 20th Century</strong> – Psychoanalysis, Classification</p>
          <p><strong>Mid 20th Century</strong> – DSM, ECT, Medications</p>
          <p><strong>70’s</strong> – Deinstitutionalization, Benzodiazepines</p>
          <p><strong>80’s</strong> – Biopsychiatry, “Chemical Imbalance”, Prozac</p>
          <p class="mb-4"><strong>90’s to Present</strong> – The Brain, Recovery Approach</p>
        </div>

        <div class="row g-3">
          <!-- Triptych with your images (left to right) -->
          <div class="col-12 col-lg-6">
            <div class="hist-card">
              <div class="row g-2">
                <div class="col-4">
                  <img class="hist-img" src="https://angelusnews.com/wp-content/uploads/2025/06/Exorcist-1024x585.jpg" alt="Exorcism bedside scene">
                </div>
                <div class="col-4">
                  <img class="hist-img" src="https://ichef.bbci.co.uk/ace/standard/976/cpsprodpb/d8cb/live/57bf0980-34e8-11f0-96c3-cf669419a2b0.jpg" alt="19th century engraving of restrained asylum patient">
                </div>
                <div class="col-4">
                  <img class="hist-img" src="https://i.ytimg.com/vi/fX5Nfv_Ww-o/maxresdefault.jpg" alt="Faith healing / ruqya ritual">
                </div>
              </div>
              <div class="hist-title">Historic practices (exorcism • asylum restraint • faith healing)</div>
            </div>
          </div>

          <!-- Single image on the right -->
          <div class="col-12 col-lg-6">
            <div class="hist-card">
              <img class="hist-wide" src="https://m.media-amazon.com/images/I/81UTwz3B78L.jpg" alt="Witch trials courtroom engraving">
              <div class="hist-title">Witch trials & moral attributions</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- COVER -->
  <section id="cover" class="section">
    <div class="container">
      <div class="deck-card p-4 p-lg-5">
        <div class="band">
          <div class="kicker">Conference Presentation</div>
          <h1 class="mt-1 mb-0">Culturally Shaped Explanatory Models of Psychological and Psychiatric Distress in Family Caregivers and their Impact on Help-Seeking Behavrior: A Cross-Sectional Study from Oman</h1>
          <p class="mb-0"><strong>Dr. Hassan Mirza</strong></p>
          <p class="mb-0">Senior Consultant</p>
          <p class="mb-0">Department of Behavioural Medicine</p>
          <p class="mb-0">SQUH</p>
        </div>
        <div class="row g-4 align-items-center">
          <div class="col-lg-8">
            <h3 class="mb-3">Study focus</h3>
            <div class="row g-3">
              <div class="col-md-6"><div class="p-3 pill">Pathways to care</div></div>
              <div class="col-md-6"><div class="p-3 pill">Family beliefs & models</div></div>
              <div class="col-md-6"><div class="p-3 pill">Delays to treatment (DUI)</div></div>
              <div class="col-md-6"><div class="p-3 pill">Predictors of indigenous healer use</div></div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="text-lg-end">
              <button class="btn btn-brand btn-lg me-2" onclick="document.documentElement.requestFullscreen?.(); $('html,body').animate({scrollTop: $('#background').offset().top - 70}, 400);">Go to Background</button>
              <button id="toggleTheme2" class="btn btn-outline-contrast btn-lg" aria-pressed="true">Dark Mode</button>
              <p class="mini mt-3 muted">Use ↑ ↓ keys to move between sections • Press F to toggle full screen</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- BACKGROUND -->
  <section id="background" class="section">
    <div class="container">
      <div class="deck-card p-4 p-lg-5">
        <div class="band"><h2 class="m-0">Background</h2></div>
        <ul class="fs-5 mb-0">
          <li>Untreated mental illness and delays remain common in Oman.</li>
          <li>Relatives’ beliefs can shape first contact (e.g., indigenous healers).</li>
          <li>We examined socio-demographic factors and explanatory models associated with:
            <ul class="mt-2">
              <li>Seeking help from indigenous healers</li>
              <li>Delay ≥ 6 months before starting treatment</li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </section>

  <!-- METHODS -->
  <section id="methods" class="section">
    <div class="container">
      <div class="deck-card p-4 p-lg-5">
        <div class="band"><h2 class="m-0">Methods</h2></div>
        <ul class="fs-5">
          <li>Design: Cross-sectional; <strong>N = 116</strong> new patients at mental health services.</li>
          <li>Measures: patient & relatives’ demographics, relatives’ explanatory models, duration of untreated illness (DUI).</li>
          <li>Outcomes: use of indigenous healers; delay ≥ 6 months in starting treatment.</li>
          <li>Analysis: univariate tests; multivariable logistic regression.</li>
        </ul>
        <div class="muted">Mean patient age 35.36 ± 9.61; mean relatives’ age 42.70 ± 10.56.</div>
      </div>
    </div>
  </section>

  <!-- PATIENTS -->
  <section id="patients" class="section">
    <div class="container">
      <div class="deck-card p-4 p-lg-5">
        <div class="band"><h2 class="m-0">Patients</h2></div>
        <div class="grid-2">
          <div>
            <h5 class="mb-2">Gender (%)</h5>
            <canvas id="patientGender"></canvas>
          </div>
          <div>
            <h5 class="mb-2">Education (%)</h5>
            <canvas id="patientEdu"></canvas>
          </div>
        </div>
        <div class="mt-4">
          <h5 class="mb-2">Place of living (%)</h5>
          <canvas id="livingArea"></canvas>
          <p class="muted mini mt-2">Mean age: 35.36 ± 9.61 years</p>
        </div>
      </div>
    </div>
  </section>

  <!-- RELATIVES -->
  <section id="relatives" class="section">
    <div class="container">
      <div class="deck-card p-4 p-lg-5">
        <div class="band"><h2 class="m-0">Relatives</h2></div>
        <div class="grid-2">
          <div>
            <h5 class="mb-2">Gender (%)</h5>
            <canvas id="relativeGender"></canvas>
          </div>
          <div>
            <h5 class="mb-2">Education (%)</h5>
            <canvas id="relativeEdu"></canvas>
          </div>
        </div>
        <div class="mt-4">
          <h5 class="mb-2">Relationship to patient (%)</h5>
          <canvas id="relationship"></canvas>
          <p class="muted mini mt-2">Relatives’ age: 42.70 ± 10.56 years</p>
        </div>
      </div>
    </div>
  </section>

  <!-- BELIEFS -->
  <section id="beliefs" class="section">
    <div class="container">
      <div class="deck-card p-4 p-lg-5">
        <div class="band"><h2 class="m-0">Beliefs & Initial Help-Seeking</h2></div>
        <div class="grid-2">
          <div>
            <h5 class="mb-2">Relatives’ explanatory models (%)</h5>
            <canvas id="models"></canvas>
          </div>
          <div>
            <h5 class="mb-2">Sought indigenous healers (%)</h5>
            <canvas id="seek"></canvas>
          </div>
        </div>
        <div class="mt-4">
          <h5 class="mb-2">Proportion endorsing indigenous model by relatives’ education</h5>
          <canvas id="indigByEdu"></canvas>
          <p class="muted mini mt-2">Higher education aligns with biomedical beliefs (p = 0.001).</p>
        </div>
      </div>
    </div>
  </section>

  <!-- DUI -->
  <section id="dui" class="section">
    <div class="container">
      <div class="deck-card p-4 p-lg-5">
        <div class="band"><h2 class="m-0">Duration of Untreated Illness (DUI)</h2></div>
        <div class="grid-2">
          <div>
            <h5 class="mb-2">By patient education (median months)</h5>
            <canvas id="duiPatientEdu"></canvas>
          </div>
          <div>
            <h5 class="mb-2">By relatives’ education (median months)</h5>
            <canvas id="duiRelativeEdu"></canvas>
          </div>
        </div>
        <div class="mt-4">
          <h5 class="mb-2">By relatives’ explanatory model (median months)</h5>
          <canvas id="duiByModel"></canvas>
          <p class="muted mini mt-2">Longest DUI when illness attributed to weak religious commitment (p &lt; 0.001).</p>
        </div>
        <div class="mt-4">
          <h5 class="mb-2">Sought indigenous healer by relatives’ model (% Yes)</h5>
          <canvas id="seekByModel"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- PREDICTORS -->
  <section id="predictors" class="section">
    <div class="container">
      <div class="deck-card p-4 p-lg-5">
        <div class="band"><h2 class="m-0">Multivariable Predictors</h2></div>
        <div class="grid-2">
          <div>
            <h5 class="mb-2">Delay ≥ 6 months (Odds Ratio, 95% CI)</h5>
            <canvas id="delayOR"></canvas>
            <p class="muted mini mt-2">Younger patient age independently predicts delay (OR 0.93, p = 0.019).</p>
          </div>
          <div>
            <h5 class="mb-2">Seeking indigenous healers (Odds Ratio, 95% CI)</h5>
            <canvas id="indigOR"></canvas>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TAKEAWAYS -->
  <section id="takeaways" class="section">
    <div class="container">
      <div class="deck-card p-4 p-lg-5">
        <div class="band"><h2 class="m-0">Key Points & Implications</h2></div>
        <div class="row g-4">
          <div class="col-lg-6">
            <h5>Key Findings</h5>
            <ul class="fs-5">
              <li>Younger patient age predicts treatment delay (≥ 6 months).</li>
              <li>Relatives’ indigenous explanatory models (black magic, personal weakness) predict use of indigenous healers.</li>
              <li>Higher relatives’ education aligns with biomedical beliefs and shorter DUI.</li>
              <li>Over half (54%) sought help from indigenous healers; mean delay ≈ 14.69 months.</li>
            </ul>
          </div>
          <div class="col-lg-6">
            <h5>Clinical & Policy Implications</h5>
            <ul class="fs-5">
              <li>Embed family-focused psychoeducation addressing explanatory models.</li>
              <li>Partner with respected indigenous healers for bidirectional referrals.</li>
              <li>Target mental-health literacy where relatives’ education is lower.</li>
            </ul>
          </div>
        </div>
        <div class="mt-4 d-flex gap-2">
          <button id="prev" class="btn btn-outline-contrast">← Previous</button>
          <button id="next" class="btn btn-brand">Next →</button>
          <button id="print" class="btn btn-outline-contrast">Export to PDF</button>
        </div>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <div class="footer">
    <div>Mental Health Pathways • Oman</div>
    <div class="muted">Use ↑ ↓ keys • Click “Export to PDF” for a printable version</div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ---------- MODE / THEME ----------
    let darkMode = true; // start in dark
    const $html = $("html");
    const $navbar = $(".navbar");
    const $toggleTheme = $("#toggleTheme");
    const $toggleTheme2 = $("#toggleTheme2");

    function applyNavbarTheme(){
      if(darkMode) $navbar.removeClass("navbar-light").addClass("navbar-dark");
      else $navbar.removeClass("navbar-dark").addClass("navbar-light");
    }

    function setThemeUI(){
      if(darkMode){
        $html.removeClass("light");
        $toggleTheme.text("Dark Mode").attr("aria-pressed","true");
        $toggleTheme2.text("Dark Mode").attr("aria-pressed","true");
      } else {
        $html.addClass("light");
        $toggleTheme.text("Light Mode").attr("aria-pressed","false");
        $toggleTheme2.text("Light Mode").attr("aria-pressed","false");
      }
      applyNavbarTheme();
      refreshChartsForTheme();
    }

    $("#toggleTheme, #toggleTheme2").on("click", function(){
      darkMode = !darkMode;
      setThemeUI();
    });

    // ---------- FULLSCREEN ----------
    function toggleFullscreen(){
      if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
      else document.exitFullscreen();
    }
    $("#start").on("click", ()=>{ toggleFullscreen(); $("html,body").animate({scrollTop: $("#cover").offset().top - 70}, 400); });
    $(document).on("keydown", function(e){
      if(e.key.toLowerCase()==="f") toggleFullscreen();
    });

    // ---------- NAV HIGHLIGHT + SMOOTH SCROLL ----------
    $("a.nav-link").on("click", function(e){
      e.preventDefault();
      const target = $(this).attr("href");
      $("html, body").animate({scrollTop: $(target).offset().top - 70}, 350);
    });

    const sections = ["#quiz","#mh-definition","#history","#cover","#background","#methods","#patients","#relatives","#beliefs","#dui","#predictors","#takeaways"];
    function currentSectionIndex(){
      const scrollTop = $(window).scrollTop() + 90;
      let idx = 0;
      sections.forEach((id,i)=>{
        if($(id).offset().top <= scrollTop) idx=i;
      });
      return idx;
    }
    function goTo(i){
      i = Math.max(0, Math.min(sections.length-1, i));
      $("html, body").stop().animate({scrollTop: $(sections[i]).offset().top - 70}, 250);
    }
    $("#prev").on("click", ()=> goTo(currentSectionIndex()-1));
    $("#next").on("click", ()=> goTo(currentSectionIndex()+1));
    $(document).on("keydown", function(e){
      if(e.key==="ArrowDown" || e.key==="PageDown") { e.preventDefault(); goTo(currentSectionIndex()+1); }
      if(e.key==="ArrowUp"   || e.key==="PageUp")   { e.preventDefault(); goTo(currentSectionIndex()-1); }
    });
    $(window).on("scroll", function(){
      const idx = currentSectionIndex();
      $(".nav-link").removeClass("active");
      $(`.nav-link[href='${sections[idx]}']`).addClass("active");
    });

    // ---------- PRINT / EXPORT ----------
    $("#print").on("click", ()=> window.print());

    // ---------- CHART HELPERS WITH THEME-AWARE COLORS ----------
    const charts = [];

    function themeColors(){
      const styles = getComputedStyle(document.documentElement);
      return {
        grid: styles.getPropertyValue('--grid').trim(),
        grid2: styles.getPropertyValue('--grid2').trim(),
        tick: styles.getPropertyValue('--tick').trim(),
        tickContrast: styles.getPropertyValue('--tick-contrast').trim()
      };
    }

    function baseChartOptions(horizontal=false){
      const c = themeColors();
      return {
        indexAxis: horizontal ? 'y' : 'x',
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          y: { beginAtZero:true, grid: { color:c.grid }, ticks: { color:c.tick } },
          x: { grid: { color:c.grid2 }, ticks: { color:c.tick } }
        },
        plugins:{ legend: { display:false }, tooltip: { enabled:true } }
      };
    }

    function barChart(id, labels, data, yLabel, horizontal=false){
      const ctx = document.getElementById(id);
      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: yLabel,
            data,
            borderWidth: 1,
            backgroundColor: 'rgba(7,110,191,0.75)',
            borderColor: 'rgba(7,110,191,1)'
          }]
        },
        options: baseChartOptions(horizontal)
      });
      charts.push(chart);
      return chart;
    }

    function forestPlot(id, items, xMin, xMax, logScale=true){
      const labels = items.map(i=>i.label);
      const data = items.map((it, idx)=>({x: it.or, y: idx}));
      const ci = items.map((it, idx)=>({lo: it.lo, hi: it.hi, y: idx}));

      const plugin = {
        id: 'ciWhiskers',
        afterDatasetsDraw(chart){
          const c = themeColors();
          const {ctx, scales:{x,y}} = chart;
          ctx.save();
          ctx.strokeStyle = c.tick;
          ctx.lineWidth = 2;
          ci.forEach(row=>{
            const yPix = y.getPixelForValue(row.y);
            const xLo = x.getPixelForValue(row.lo);
            const xHi = x.getPixelForValue(row.hi);
            ctx.beginPath(); ctx.moveTo(xLo, yPix); ctx.lineTo(xHi, yPix); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(xLo, yPix-6); ctx.lineTo(xLo, yPix+6); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(xHi, yPix-6); ctx.lineTo(xHi, yPix+6); ctx.stroke();
          });
          const oneX = x.getPixelForValue(1);
          ctx.setLineDash([4,4]); ctx.lineWidth=1.5; ctx.strokeStyle=c.grid;
          ctx.beginPath(); ctx.moveTo(oneX, y.top); ctx.lineTo(oneX, y.bottom); ctx.stroke();
          ctx.restore();
        }
      };

      const c = themeColors();
      const chart = new Chart(document.getElementById(id), {
        type:'scatter',
        data:{ labels, datasets:[{ label:'OR', data, pointRadius:5, pointBackgroundColor:'rgba(0,173,181,1)', pointBorderColor:'rgba(0,173,181,1)'}] },
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{
            x: {
              type: logScale ? 'logarithmic' : 'linear', min: xMin, max: xMax,
              grid: { color:c.grid }, ticks: { color:c.tick },
              title:{ display:true, text:'Odds Ratio', color:c.tick }
            },
            y:{
              type:'linear', min:-0.5, max: labels.length - 0.5,
              ticks:{ callback:(val)=> labels[val] ?? '', color:c.tick },
              grid: { color:c.grid2 }
            }
          },
          plugins:{ legend:{display:false}, tooltip:{enabled:true} }
        },
        plugins:[plugin]
      });
      charts.push(chart);
      return chart;
    }

    function refreshChartsForTheme(){
      const c = themeColors();
      charts.forEach(ch=>{
        const scales = ch.options.scales;
        if(scales.x){
          scales.x.grid.color = c.grid2;
          if(scales.x.ticks) scales.x.ticks.color = c.tick;
          if(scales.x.title){ scales.x.title.color = c.tick; }
        }
        if(scales.y){
          scales.y.grid.color = c.grid;
          if(scales.y.ticks) scales.y.ticks.color = c.tick;
        }
        ch.update('none');
      });
    }

    // ---------- DATA (CREATE CHARTS) ----------
    // Patients
    barChart('patientGender', ['Male','Female'], [33.6,66.4], '%', true);
    barChart('patientEdu', ['Illiterate','Not completed\nsecondary','Secondary','University'], [4.3,8.6,37.9,49.1], '%', true);
    barChart('livingArea', ['Urban','Rural'], [20.7,79.3], '%');

    // Relatives
    barChart('relativeGender', ['Male','Female'], [75.9,24.1], '%', true);
    barChart('relativeEdu', ['Illiterate','Not completed\nsecondary','Secondary','University'], [6.9,31.9,46.6,14.7], '%', true);
    barChart('relationship', ['Parents','Brother/sister','Husband/wife','Daughter/son','Other'], [31.9,35.3,17.2,7.8,7.8], '%');

    // Beliefs & help-seeking
    barChart('models', ['Mental illness','Black magic /\nevil eye','Personal weakness','Weak religious\ncommitment','Others'], [35.3,31.0,16.4,11.2,6.0], '%', true);
    barChart('seek', ['Yes','No','Not sure'], [54.3,34.5,11.2], '%');
    barChart('indigByEdu', ['Illiterate','Not completed\nsecondary','High school','University'], [75.0,83.8,63.1,29.4], '%', true);

    // DUI
    barChart('duiPatientEdu', ['Illiterate','Not completed\nsecondary','Secondary','Higher'], [2,5,12,10], 'Months', true);
    barChart('duiRelativeEdu', ['Illiterate','Not completed\nsecondary','Secondary','Higher'], [19.5,14,7,10], 'Months', true);
    barChart('duiByModel', ['Personal\nweakness','Black magic','Weak religious\ncommitment','Mental illness','Others'], [14,10,48,8,2], 'Months', true);
    barChart('seekByModel', ['Personal\nweakness','Black magic','Weak religious\ncommitment','Mental illness','Others'], [63.2,77.8,53.8,31.7,42.8], '%', true);

    // Predictors (forest)
    forestPlot('delayOR', [
      {label:'Patient age (per year)', or:0.932, lo:0.879, hi:0.989}
    ], 0.5, 1.2, true);

    forestPlot('indigOR', [
      {label:'Rel. edu: Not completed secondary (vs Univ.)', or:0.173, lo:0.042, hi:0.705},
      {label:'Rel. model: Personal weakness', or:5.282, lo:1.320, hi:21.131},
      {label:'Rel. model: Black magic / evil eye', or:11.65, lo:3.234, hi:41.931},
      {label:'Rel. model: Weak religious commitment', or:2.557, lo:0.554, hi:11.829},
      {label:'Rel. model: Other', or:1.587, lo:0.282, hi:8.868},
    ], 0.1, 60, true);

    // ---------- QR CODE ----------
    $(function(){
      const url = "https://www.ahaslides.com/GMHC2025";
      new QRCode(document.getElementById("qrCode"), {
        text: url,
        width: 256,
        height: 256,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
      });
      // Initialize theme UI after QR creation
      setThemeUI();
    });
  </script>
</body>
</html>


